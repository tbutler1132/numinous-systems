<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Expressions</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap");

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Georgia", serif;
        background: #faf9f7;
        color: #2c2c2c;
        line-height: 1.7;
        min-height: 100vh;
        transition: all 0.4s ease;
      }

      .container {
        max-width: 640px;
        margin: 0 auto;
        padding: 3rem 1.5rem;
      }

      h1 {
        font-size: 1.75rem;
        font-weight: 400;
        margin-bottom: 0.5rem;
        letter-spacing: -0.02em;
        transition: all 0.4s ease;
      }

      .subtitle {
        color: #666;
        font-size: 0.95rem;
        margin-bottom: 2.5rem;
        transition: color 0.4s ease;
      }

      /* Header with edit link */
      .header-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 0.5rem;
      }

      .edit-profile-link {
        font-size: 0.85rem;
        color: #888;
        text-decoration: none;
        transition: color 0.15s;
      }

      .edit-profile-link:hover {
        color: #2c2c2c;
      }

      /* Artifact List */
      .artifacts {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .artifact {
        padding: 1rem 1.25rem;
        background: #fff;
        border: 1px solid #e8e6e3;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .artifact:hover {
        border-color: #ccc;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }

      .artifact-title {
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 0.25rem;
        transition: color 0.4s ease;
      }

      .artifact-desc {
        font-size: 0.9rem;
        color: #666;
        transition: color 0.4s ease;
      }

      /* Profile Form */
      .question {
        margin-bottom: 2rem;
      }

      .question-text {
        font-size: 1rem;
        margin-bottom: 0.75rem;
        font-weight: 500;
        transition: color 0.4s ease;
      }

      .options {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .option {
        padding: 0.5rem 1rem;
        background: #fff;
        border: 1px solid #e8e6e3;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.15s;
      }

      .option:hover {
        border-color: #999;
      }

      .option.selected {
        background: #2c2c2c;
        color: #fff;
        border-color: #2c2c2c;
      }

      /* Buttons */
      .btn {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        background: #2c2c2c;
        color: #fff;
        border: none;
        border-radius: 4px;
        font-size: 0.95rem;
        cursor: pointer;
        font-family: inherit;
        transition: all 0.3s ease;
      }

      .btn:hover {
        background: #444;
      }
      .btn:disabled {
        background: #999;
        cursor: not-allowed;
        box-shadow: none;
      }

      .btn-secondary {
        background: #fff;
        color: #2c2c2c;
        border: 1px solid #e8e6e3;
      }

      .btn-secondary:hover {
        background: #f5f5f5;
      }

      .btn-group {
        display: flex;
        gap: 0.75rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
      }

      /* Back link */
      .back {
        display: inline-block;
        margin-bottom: 1.5rem;
        color: #666;
        text-decoration: none;
        font-size: 0.9rem;
        transition: color 0.4s ease;
      }

      .back:hover {
        color: #2c2c2c;
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 3rem 0;
      }

      .loading p {
        transition: color 0.4s ease;
      }

      .loading-inline {
        padding: 2rem 0;
      }

      .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid #e8e6e3;
        border-top-color: #2c2c2c;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 1rem;
        transition: border-color 0.4s ease;
      }

      .spinner-small {
        width: 20px;
        height: 20px;
        border-width: 2px;
        margin-bottom: 0.5rem;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* About section */
      .about-section {
        background: #fff;
        border: 1px solid #e8e6e3;
        border-radius: 6px;
        padding: 1.5rem 2rem;
        margin-bottom: 2rem;
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
      }

      .about-section h1,
      .about-section h2,
      .about-section h3 {
        margin: 1rem 0 0.5rem;
        font-size: 1.1rem;
        transition: all 0.4s ease;
      }

      .about-section h1:first-child,
      .about-section h2:first-child {
        margin-top: 0;
      }

      .about-section p {
        margin-bottom: 0.75rem;
        font-size: 0.95rem;
      }

      .about-section ul,
      .about-section ol {
        margin: 0.75rem 0;
        padding-left: 1.25rem;
        font-size: 0.95rem;
      }

      .about-section li {
        margin-bottom: 0.35rem;
      }

      /* Context text */
      .context-text {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 1rem;
        font-style: italic;
        transition: color 0.4s ease;
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 0;
        margin-bottom: 1rem;
        border-bottom: 1px solid #e8e6e3;
        transition: border-color 0.4s ease;
      }

      .tab {
        padding: 0.75rem 1.25rem;
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        font-family: inherit;
        font-size: 0.95rem;
        color: #888;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: -1px;
      }

      .tab:hover {
        color: #2c2c2c;
      }

      .tab.active {
        color: #2c2c2c;
        border-bottom-color: #2c2c2c;
      }

      /* Content boxes */
      .content-box {
        background: #fff;
        border: 1px solid #e8e6e3;
        border-radius: 6px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
      }

      .content-box h1,
      .content-box h2,
      .content-box h3 {
        margin: 1.5rem 0 0.75rem;
        transition: all 0.4s ease;
      }

      .content-box h1:first-child,
      .content-box h2:first-child {
        margin-top: 0;
      }

      .content-box p {
        margin-bottom: 1rem;
      }

      .content-box blockquote {
        border-left: 3px solid #e8e6e3;
        padding-left: 1rem;
        margin: 1rem 0;
        color: #666;
        transition: all 0.4s ease;
      }

      .content-box ul,
      .content-box ol {
        margin: 1rem 0;
        padding-left: 1.5rem;
      }

      .content-box li {
        margin-bottom: 0.5rem;
      }

      .content-box table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        font-size: 0.9rem;
      }

      .content-box th,
      .content-box td {
        border: 1px solid #e8e6e3;
        padding: 0.5rem 0.75rem;
        text-align: left;
        transition: all 0.4s ease;
      }

      .content-box th {
        background: #faf9f7;
        font-weight: 500;
        transition: background 0.4s ease;
      }

      .content-box hr {
        border: none;
        border-top: 1px solid #e8e6e3;
        margin: 2rem 0;
        transition: border-color 0.4s ease;
      }

      /* Generate prompt */
      .generate-prompt {
        text-align: center;
        padding: 2.5rem 1.5rem;
        background: #fff;
        border: 1px solid #e8e6e3;
        border-radius: 6px;
        margin-bottom: 1.5rem;
        transition: all 0.4s ease;
      }

      .generate-prompt p {
        margin-bottom: 1.25rem;
        color: #666;
        transition: color 0.4s ease;
      }

      /* Mode label */
      .mode-label {
        display: inline-block;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 1rem;
        font-style: italic;
        transition: all 0.4s ease;
      }

      .limit-notice {
        font-size: 0.85rem;
        color: #999;
        margin-top: 1rem;
        transition: color 0.4s ease;
      }

      /* ======================= */
      /* MACHINIC THEME (Digital/Synthetic) - Full Page */
      /* ======================= */

      body.machinic {
        background: #f0f4f8;
        color: #1e293b;
      }

      body.machinic h1 {
        font-family: "JetBrains Mono", monospace;
        color: #0f172a;
        letter-spacing: -0.03em;
      }

      body.machinic .subtitle {
        color: #64748b;
      }

      body.machinic .back {
        color: #64748b;
      }

      body.machinic .back:hover {
        color: #0ea5e9;
      }

      body.machinic .context-text {
        color: #64748b;
      }

      /* Machinic about section */
      body.machinic .about-section {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-color: #94a3b8;
        color: #1e293b;
        box-shadow: 0 0 30px rgba(14, 165, 233, 0.06);
      }

      body.machinic .about-section::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image: linear-gradient(
            rgba(14, 165, 233, 0.04) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(14, 165, 233, 0.04) 1px, transparent 1px);
        background-size: 24px 24px;
        pointer-events: none;
      }

      body.machinic .about-section h1,
      body.machinic .about-section h2,
      body.machinic .about-section h3 {
        font-family: "JetBrains Mono", monospace;
        color: #0f172a;
      }

      /* Machinic content box */
      body.machinic .content-box {
        background: linear-gradient(135deg, #f8fafc 0%, #f0f4f8 100%);
        border-color: #94a3b8;
        color: #1e293b;
        box-shadow: 0 0 24px rgba(14, 165, 233, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.9);
      }

      body.machinic .content-box::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image: linear-gradient(
            rgba(14, 165, 233, 0.03) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(14, 165, 233, 0.03) 1px, transparent 1px);
        background-size: 20px 20px;
        pointer-events: none;
      }

      body.machinic .content-box h1,
      body.machinic .content-box h2,
      body.machinic .content-box h3 {
        color: #0f172a;
        font-family: "JetBrains Mono", monospace;
        font-weight: 500;
      }

      body.machinic .content-box blockquote {
        border-left-color: #0ea5e9;
        color: #64748b;
        background: rgba(14, 165, 233, 0.05);
        padding: 0.75rem 1rem;
        border-radius: 0 4px 4px 0;
      }

      body.machinic .content-box th {
        background: rgba(14, 165, 233, 0.1);
        font-family: "JetBrains Mono", monospace;
        font-size: 0.85rem;
        color: #0f172a;
      }

      body.machinic .content-box th,
      body.machinic .content-box td {
        border-color: #94a3b8;
      }

      body.machinic .content-box hr {
        border-top-color: #94a3b8;
      }

      /* Machinic tabs */
      body.machinic .tabs {
        border-bottom-color: #94a3b8;
      }

      body.machinic .tab {
        color: #64748b;
      }

      body.machinic .tab:hover {
        color: #0ea5e9;
      }

      body.machinic .tab.active {
        color: #0ea5e9;
        border-bottom-color: #0ea5e9;
      }

      /* Machinic generate prompt */
      body.machinic .generate-prompt {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-color: #94a3b8;
      }

      body.machinic .generate-prompt p {
        color: #64748b;
      }

      /* Machinic buttons */
      body.machinic .btn {
        background: #0ea5e9;
        box-shadow: 0 0 16px rgba(14, 165, 233, 0.4);
      }

      body.machinic .btn:hover {
        background: #0284c7;
        box-shadow: 0 0 24px rgba(14, 165, 233, 0.5);
      }

      body.machinic .btn-secondary {
        background: rgba(255, 255, 255, 0.9);
        border-color: #94a3b8;
        color: #1e293b;
        box-shadow: none;
      }

      body.machinic .btn-secondary:hover {
        background: #fff;
        border-color: #0ea5e9;
      }

      body.machinic .mode-label {
        color: #0ea5e9;
        font-family: "JetBrains Mono", monospace;
      }

      body.machinic .spinner {
        border-color: #94a3b8;
        border-top-color: #0ea5e9;
      }

      body.machinic .limit-notice {
        color: #64748b;
      }

      /* ======================= */
      /* ORGANIC THEME (Natural/Human) - Full Page */
      /* ======================= */

      body.organic {
        background: #faf6f0;
        color: #4a4235;
      }

      body.organic h1 {
        color: #3d3628;
      }

      body.organic .subtitle {
        color: #8b7355;
      }

      body.organic .back {
        color: #8b7355;
      }

      body.organic .back:hover {
        color: #4a4235;
      }

      body.organic .context-text {
        color: #8b7355;
      }

      /* Organic about section */
      body.organic .about-section {
        background: #f5efe6;
        border-color: #c9b99a;
        color: #4a4235;
      }

      body.organic .about-section::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        opacity: 0.03;
        pointer-events: none;
      }

      body.organic .about-section h1,
      body.organic .about-section h2,
      body.organic .about-section h3 {
        color: #3d3628;
      }

      /* Organic content box */
      body.organic .content-box {
        background: #f5efe6;
        border-color: #c9b99a;
        color: #4a4235;
      }

      body.organic .content-box::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        opacity: 0.04;
        pointer-events: none;
      }

      body.organic .content-box h1,
      body.organic .content-box h2,
      body.organic .content-box h3 {
        color: #3d3628;
      }

      body.organic .content-box blockquote {
        border-left-color: #c9b99a;
        color: #6b5d4d;
      }

      body.organic .content-box th {
        background: #ebe4d8;
      }

      body.organic .content-box th,
      body.organic .content-box td {
        border-color: #c9b99a;
      }

      body.organic .content-box hr {
        border-top-color: #c9b99a;
      }

      /* Organic tabs */
      body.organic .tabs {
        border-bottom-color: #c9b99a;
      }

      body.organic .tab {
        color: #a89880;
      }

      body.organic .tab:hover {
        color: #6b5d4d;
      }

      body.organic .tab.active {
        color: #8b7355;
        border-bottom-color: #8b7355;
      }

      /* Organic generate prompt */
      body.organic .generate-prompt {
        background: #f5efe6;
        border-color: #c9b99a;
      }

      body.organic .generate-prompt p {
        color: #8b7355;
      }

      /* Organic buttons */
      body.organic .btn {
        background: #8b7355;
        box-shadow: none;
      }

      body.organic .btn:hover {
        background: #6b5d4d;
      }

      body.organic .btn-secondary {
        background: #faf6f0;
        border-color: #c9b99a;
        color: #4a4235;
      }

      body.organic .btn-secondary:hover {
        background: #f5efe6;
      }

      body.organic .mode-label {
        color: #8b7355;
      }

      body.organic .spinner {
        border-color: #c9b99a;
        border-top-color: #8b7355;
      }

      body.organic .limit-notice {
        color: #a89880;
      }

      /* Screen visibility */
      .screen {
        display: none;
      }
      .screen.active {
        display: block;
      }

      /* Dev Usage Overlay */
      .dev-usage-overlay {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        background: rgba(15, 23, 42, 0.92);
        color: #e2e8f0;
        font-family: "JetBrains Mono", monospace;
        font-size: 0.75rem;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        z-index: 9999;
        min-width: 200px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(148, 163, 184, 0.2);
      }

      .dev-usage-overlay .overlay-title {
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: #94a3b8;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }

      .dev-usage-overlay .overlay-title::before {
        content: "";
        display: inline-block;
        width: 6px;
        height: 6px;
        background: #22c55e;
        border-radius: 50%;
        animation: pulse-dot 2s infinite;
      }

      @keyframes pulse-dot {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }

      .dev-usage-overlay .usage-row {
        display: flex;
        justify-content: space-between;
        padding: 0.2rem 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      }

      .dev-usage-overlay .usage-row:last-child {
        border-bottom: none;
      }

      .dev-usage-overlay .usage-label {
        color: #94a3b8;
      }

      .dev-usage-overlay .usage-value {
        color: #f8fafc;
        font-weight: 500;
      }

      .dev-usage-overlay .usage-value.cost {
        color: #fbbf24;
      }

      .dev-usage-overlay .section-divider {
        height: 1px;
        background: rgba(148, 163, 184, 0.2);
        margin: 0.5rem 0;
      }

      .dev-usage-overlay .section-label {
        font-size: 0.6rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #64748b;
        margin-bottom: 0.25rem;
        margin-top: 0.25rem;
      }

      /* Tab content visibility */
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      /* Expression reveal animations */
      @keyframes revealLine {
        from {
          opacity: 0;
          transform: translateY(12px);
          filter: blur(2px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
          filter: blur(0);
        }
      }

      @keyframes containerGlow {
        0% {
          box-shadow: 0 0 0 rgba(14, 165, 233, 0);
        }
        50% {
          box-shadow: 0 0 40px rgba(14, 165, 233, 0.3);
        }
        100% {
          box-shadow: 0 0 24px rgba(14, 165, 233, 0.1);
        }
      }

      .reveal-line {
        animation: revealLine 0.5s ease-out forwards;
        opacity: 0;
      }

      .content-box.revealing {
        animation: containerGlow 0.8s ease-out;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Onboarding Screen -->
      <div id="onboarding-screen" class="screen">
        <h1>Expressions</h1>
        <p class="subtitle">
          These are my ideas, presented in a way that resonates with you. First,
          tell me a bit about how you engage with concepts.
        </p>

        <div class="question">
          <div class="question-text">How do you prefer ideas presented?</div>
          <div class="options" data-question="register">
            <div class="option" data-value="direct">Direct</div>
            <div class="option" data-value="poetic">Poetic</div>
            <div class="option" data-value="analytical">Analytical</div>
            <div class="option" data-value="conversational">Conversational</div>
          </div>
        </div>

        <div class="question">
          <div class="question-text">Your relationship to the sacred?</div>
          <div class="options" data-question="sacred">
            <div class="option" data-value="theist">Theist</div>
            <div class="option" data-value="secular">Secular but open</div>
            <div class="option" data-value="materialist">Materialist</div>
            <div class="option" data-value="exploring">Exploring</div>
          </div>
        </div>

        <div class="question">
          <div class="question-text">What draws you in?</div>
          <div class="options" data-question="mode">
            <div class="option" data-value="logic">Logic</div>
            <div class="option" data-value="stories">Stories</div>
            <div class="option" data-value="abstractions">Abstractions</div>
            <div class="option" data-value="practical">
              Practical application
            </div>
          </div>
        </div>

        <div class="question">
          <div class="question-text">Which resonates most?</div>
          <div class="options" data-question="influences">
            <div class="option" data-value="ancient">Ancient philosophy</div>
            <div class="option" data-value="science">Modern science</div>
            <div class="option" data-value="art">Art & aesthetics</div>
            <div class="option" data-value="contemplative">
              Contemplative traditions
            </div>
          </div>
        </div>

        <button
          class="btn"
          id="save-profile-btn"
          disabled
          onclick="saveProfileAndContinue()"
        >
          Continue
        </button>
      </div>

      <!-- Select Screen -->
      <div id="select-screen" class="screen">
        <div class="header-row">
          <h1>Expressions</h1>
          <a
            href="#"
            class="edit-profile-link"
            onclick="editProfile(); return false;"
            >Edit profile</a
          >
        </div>
        <p class="subtitle">
          Each artifact is a core idea of this project. Select one to explore it
          in a way shaped for you.
        </p>
        <div class="artifacts" id="artifact-list"></div>
      </div>

      <!-- Loading Screen (for initial artifact fetch) -->
      <div id="loading-screen" class="screen">
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading artifact...</p>
        </div>
      </div>

      <!-- Dev Usage Overlay (only visible on localhost) -->
      <div
        id="dev-usage-overlay"
        class="dev-usage-overlay"
        style="display: none"
      >
        <div class="overlay-title">API Usage (Dev)</div>
        <div class="section-label">Last Request</div>
        <div class="usage-row">
          <span class="usage-label">Input</span>
          <span class="usage-value" id="usage-input">—</span>
        </div>
        <div class="usage-row">
          <span class="usage-label">Output</span>
          <span class="usage-value" id="usage-output">—</span>
        </div>
        <div class="usage-row">
          <span class="usage-label">Cost</span>
          <span class="usage-value cost" id="usage-cost">—</span>
        </div>
        <div class="section-divider"></div>
        <div class="section-label">Session Total</div>
        <div class="usage-row">
          <span class="usage-label">Tokens</span>
          <span class="usage-value" id="usage-session-tokens">0</span>
        </div>
        <div class="usage-row">
          <span class="usage-label">Cost</span>
          <span class="usage-value cost" id="usage-session-cost">$0.00</span>
        </div>
      </div>

      <!-- Detail Screen -->
      <div id="detail-screen" class="screen">
        <a href="#" class="back" onclick="backToArtifacts(); return false;"
          >← Back to artifacts</a
        >
        <h1 id="detail-title"></h1>

        <div class="about-section" id="about-content"></div>

        <p class="context-text">
          Toggle between the machinic—an AI-generated expression shaped for your
          sensibility—and the organic raw notes. The core truth remains; only
          the vessel changes.
        </p>

        <div class="tabs">
          <button
            class="tab active"
            data-tab="machinic"
            onclick="switchTab('machinic')"
          >
            Machinic
          </button>
          <button class="tab" data-tab="organic" onclick="switchTab('organic')">
            Organic
          </button>
        </div>

        <div id="machinic-tab" class="tab-content active">
          <!-- Before generation -->
          <div id="generate-prompt" class="generate-prompt">
            <p>Generate a machinic expression tailored to your sensibility.</p>
            <button class="btn" id="generate-btn" onclick="generate()">
              Generate Machinic Expression
            </button>
          </div>

          <!-- After generation -->
          <div id="expression-result" style="display: none">
            <span class="mode-label">Machinic synthesis</span>
            <div class="content-box" id="expression-content"></div>
            <div class="btn-group">
              <button class="btn btn-secondary" onclick="download()">
                Download as Markdown
              </button>
              <button class="btn" id="regenerate-btn" onclick="regenerate()">
                Regenerate
              </button>
            </div>
            <p class="limit-notice" id="limit-notice"></p>
          </div>

          <!-- Generating -->
          <div
            id="generating-indicator"
            class="loading loading-inline"
            style="display: none"
          >
            <div class="spinner spinner-small"></div>
            <p>Synthesizing your expression...</p>
          </div>
        </div>

        <div id="organic-tab" class="tab-content">
          <span class="mode-label">Raw working notes</span>
          <div class="content-box" id="organics-content"></div>
        </div>
      </div>
    </div>

    <script>
      // GitHub raw URL base
      const GITHUB_RAW_BASE =
        "https://raw.githubusercontent.com/tbutler1132/vital-systems/main/nodes/org/artifacts/core";

      // Artifact data - Core essays only
      const artifacts = [
        {
          id: "1-beauty-redeems",
          title: "Beauty Redeems",
          desc: "Moments of beauty redeem existence",
        },
        {
          id: "2-the-living-system",
          title: "The Living System",
          desc: "Living systems, hybrid beings, viability over optimization",
        },
        {
          id: "3-love-of-fate",
          title: "Love of Fate",
          desc: "Clearing regret for presence",
        },
        {
          id: "4-capital-as-medium",
          title: "Capital as Medium",
          desc: "Orchestrating capital toward beauty",
        },
        {
          id: "5-axioms",
          title: "Axioms",
          desc: "The distilled principles—what is affirmed without argument",
        },
      ];

      // State
      let selectedArtifact = null;
      let profile = {
        register: null,
        sacred: null,
        mode: null,
        influences: null,
      };
      let currentExpression = "";
      let currentAbout = "";
      let currentNotes = "";
      let currentTab = "machinic";
      let hasGenerated = false;

      // Dev usage tracking
      const isDevMode =
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1";
      let sessionUsage = { input_tokens: 0, output_tokens: 0 };

      // Claude Sonnet pricing (per 1M tokens)
      const PRICING = {
        input: 3.0, // $3 per 1M input tokens
        output: 15.0, // $15 per 1M output tokens
      };

      function calculateCost(input_tokens, output_tokens) {
        const inputCost = (input_tokens / 1_000_000) * PRICING.input;
        const outputCost = (output_tokens / 1_000_000) * PRICING.output;
        return inputCost + outputCost;
      }

      function formatCost(cost) {
        if (cost < 0.01) {
          return `$${cost.toFixed(4)}`;
        }
        return `$${cost.toFixed(2)}`;
      }

      function updateDevUsageOverlay(usage) {
        if (!isDevMode) return;

        const overlay = document.getElementById("dev-usage-overlay");
        overlay.style.display = "block";

        // Update last request
        document.getElementById("usage-input").textContent =
          usage.input_tokens.toLocaleString();
        document.getElementById("usage-output").textContent =
          usage.output_tokens.toLocaleString();
        const requestCost = calculateCost(
          usage.input_tokens,
          usage.output_tokens
        );
        document.getElementById("usage-cost").textContent =
          formatCost(requestCost);

        // Update session totals
        sessionUsage.input_tokens += usage.input_tokens;
        sessionUsage.output_tokens += usage.output_tokens;
        const totalTokens =
          sessionUsage.input_tokens + sessionUsage.output_tokens;
        document.getElementById("usage-session-tokens").textContent =
          totalTokens.toLocaleString();
        const sessionCost = calculateCost(
          sessionUsage.input_tokens,
          sessionUsage.output_tokens
        );
        document.getElementById("usage-session-cost").textContent =
          formatCost(sessionCost);
      }

      function initDevOverlay() {
        if (isDevMode) {
          document.getElementById("dev-usage-overlay").style.display = "block";
        }
      }

      // Initialize on page load
      function init() {
        // Check for stored profile
        const storedProfile = localStorage.getItem("expressions:profile");
        if (storedProfile) {
          profile = JSON.parse(storedProfile);
          showScreen("select");
        } else {
          showScreen("onboarding");
        }

        // Render artifact list
        renderArtifactList();

        // Set up option selection for onboarding
        setupOptionSelection();

        // Initialize dev overlay if in dev mode
        initDevOverlay();
      }

      function renderArtifactList() {
        const listEl = document.getElementById("artifact-list");
        listEl.innerHTML = "";
        artifacts.forEach((a) => {
          const div = document.createElement("div");
          div.className = "artifact";
          div.innerHTML = `<div class="artifact-title">${a.title}</div><div class="artifact-desc">${a.desc}</div>`;
          div.onclick = () => selectArtifact(a);
          listEl.appendChild(div);
        });
      }

      function setupOptionSelection() {
        document.querySelectorAll(".options").forEach((group) => {
          const question = group.dataset.question;
          group.querySelectorAll(".option").forEach((opt) => {
            opt.onclick = () => {
              group
                .querySelectorAll(".option")
                .forEach((o) => o.classList.remove("selected"));
              opt.classList.add("selected");
              profile[question] = opt.dataset.value;
              checkProfileComplete();
            };
          });
        });
      }

      function checkProfileComplete() {
        const complete = Object.values(profile).every((v) => v !== null);
        const btn = document.getElementById("save-profile-btn");
        if (btn) btn.disabled = !complete;
      }

      function saveProfileAndContinue() {
        localStorage.setItem("expressions:profile", JSON.stringify(profile));
        showScreen("select");
      }

      function editProfile() {
        // Reset UI to show current selections
        profile = {
          register: null,
          sacred: null,
          mode: null,
          influences: null,
        };
        document
          .querySelectorAll(".option")
          .forEach((o) => o.classList.remove("selected"));

        // Restore from localStorage
        const storedProfile = localStorage.getItem("expressions:profile");
        if (storedProfile) {
          profile = JSON.parse(storedProfile);
          // Mark selected options
          Object.entries(profile).forEach(([question, value]) => {
            if (value) {
              const opt = document.querySelector(
                `.options[data-question="${question}"] .option[data-value="${value}"]`
              );
              if (opt) opt.classList.add("selected");
            }
          });
        }

        checkProfileComplete();
        showScreen("onboarding");
      }

      async function selectArtifact(artifact) {
        // Check for stored expression content
        const storedExpr = localStorage.getItem(
          `expressions:${artifact.id}:content`
        );

        selectedArtifact = artifact;

        // Restore expression if it exists in localStorage
        if (storedExpr) {
          hasGenerated = true;
          currentExpression = storedExpr;
        } else {
          hasGenerated = false;
          currentExpression = "";
        }

        // Show loading while fetching content
        showScreen("loading");

        try {
          // Fetch about and notes from GitHub
          const [aboutRes, notesRes] = await Promise.all([
            fetch(`${GITHUB_RAW_BASE}/${artifact.id}/about.md`),
            fetch(`${GITHUB_RAW_BASE}/${artifact.id}/notes.md`),
          ]);

          if (!aboutRes.ok || !notesRes.ok) {
            throw new Error("Failed to fetch artifact content");
          }

          currentAbout = await aboutRes.text();
          currentNotes = await notesRes.text();

          // Update the detail screen
          document.getElementById("detail-title").textContent = artifact.title;
          document.getElementById("about-content").innerHTML =
            marked.parse(currentAbout);
          document.getElementById("organics-content").innerHTML =
            marked.parse(currentNotes);

          // Reset to machinic tab
          resetDetailScreen();

          // If we have a stored expression, show it instead of generate prompt
          if (hasGenerated && currentExpression) {
            document.getElementById("generate-prompt").style.display = "none";
            document.getElementById("expression-content").innerHTML =
              marked.parse(currentExpression);
            document.getElementById("expression-result").style.display =
              "block";

            // Update limit notice
            const count = getGenerationCount(artifact.id);
            const remaining = 2 - count;
            const limitEl = document.getElementById("limit-notice");
            const regenBtn = document.getElementById("regenerate-btn");

            if (remaining > 0) {
              limitEl.textContent = `${remaining} regeneration${
                remaining > 1 ? "s" : ""
              } remaining for this artifact.`;
              regenBtn.disabled = false;
            } else {
              limitEl.textContent =
                "No regenerations remaining. Sit with this expression.";
              regenBtn.disabled = true;
            }

            // Apply machinic theme
            document.body.classList.add("machinic");
          }

          switchTab("machinic");

          // Check generation count and update UI
          updateGenerateButton();

          showScreen("detail");
        } catch (err) {
          console.error(err);
          alert("Failed to load artifact. Please try again.");
          showScreen("select");
        }
      }

      function resetDetailScreen() {
        document.getElementById("generate-prompt").style.display = "block";
        document.getElementById("expression-result").style.display = "none";
        document.getElementById("generating-indicator").style.display = "none";
        // Clear body theme classes
        document.body.classList.remove("organic", "machinic");
      }

      function backToArtifacts() {
        // Clear theme when going back
        document.body.classList.remove("organic", "machinic");
        showScreen("select");
      }

      function updateGenerateButton() {
        const count = getGenerationCount(selectedArtifact.id);
        const btn = document.getElementById("generate-btn");

        if (count >= 2) {
          btn.disabled = true;
          btn.textContent = "Maximum generations reached";
        } else {
          btn.disabled = false;
          btn.textContent = "Generate Machinic Expression";
        }
      }

      function showScreen(name) {
        document
          .querySelectorAll(".screen")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(name + "-screen").classList.add("active");
      }

      function switchTab(tabName) {
        currentTab = tabName;

        // Update tab buttons
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelector(`.tab[data-tab="${tabName}"]`)
          .classList.add("active");

        // Update tab content
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));
        document.getElementById(tabName + "-tab").classList.add("active");

        // Toggle theme classes on body for full page effect
        document.body.classList.remove("organic", "machinic");

        if (tabName === "organic") {
          document.body.classList.add("organic");
        } else if (tabName === "machinic" && hasGenerated) {
          document.body.classList.add("machinic");
        }
      }

      function getGenerationCount(artifactId) {
        return parseInt(
          localStorage.getItem(`expressions:${artifactId}`) || "0"
        );
      }

      function incrementGenerationCount(artifactId) {
        const count = getGenerationCount(artifactId) + 1;
        localStorage.setItem(`expressions:${artifactId}`, count.toString());
        return count;
      }

      async function generate() {
        const count = getGenerationCount(selectedArtifact.id);
        if (count >= 2) {
          alert(
            "You've reached the maximum of 2 generations for this artifact. Sit with what you have."
          );
          return;
        }

        // Show generating indicator
        document.getElementById("generate-prompt").style.display = "none";
        document.getElementById("expression-result").style.display = "none";
        document.getElementById("generating-indicator").style.display = "block";

        try {
          const res = await fetch("/api/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ artifact: selectedArtifact.id, profile }),
          });

          if (!res.ok) throw new Error("Generation failed");

          const data = await res.json();
          currentExpression = data.expression;
          hasGenerated = true;

          // Update dev usage overlay if usage data is present
          if (data.usage) {
            updateDevUsageOverlay(data.usage);
          }

          const newCount = incrementGenerationCount(selectedArtifact.id);

          // Store the expression content in localStorage for persistence
          localStorage.setItem(
            `expressions:${selectedArtifact.id}:content`,
            currentExpression
          );

          // Apply machinic theme to body
          document.body.classList.add("machinic");

          // Show expression result
          document.getElementById("generating-indicator").style.display =
            "none";
          const expressionContainer =
            document.getElementById("expression-content");
          expressionContainer.innerHTML = marked.parse(currentExpression);
          document.getElementById("expression-result").style.display = "block";

          // Animate the reveal
          revealExpression(expressionContainer);

          // Update limit notice and regenerate button
          const remaining = 2 - newCount;
          const limitEl = document.getElementById("limit-notice");
          const regenBtn = document.getElementById("regenerate-btn");

          if (remaining > 0) {
            limitEl.textContent = `${remaining} regeneration${
              remaining > 1 ? "s" : ""
            } remaining for this artifact.`;
            regenBtn.disabled = false;
          } else {
            limitEl.textContent =
              "No regenerations remaining. Sit with this expression.";
            regenBtn.disabled = true;
          }
        } catch (err) {
          console.error(err);
          alert("Failed to generate expression. Please try again.");
          // Reset to show generate button
          document.getElementById("generating-indicator").style.display =
            "none";
          document.getElementById("generate-prompt").style.display = "block";
        }
      }

      function regenerate() {
        generate();
      }

      function revealExpression(containerEl) {
        containerEl.classList.add("revealing");
        const children = containerEl.querySelectorAll(
          "p, h1, h2, h3, ul, ol, blockquote"
        );
        children.forEach((el, i) => {
          el.classList.add("reveal-line");
          el.style.animationDelay = `${i * 0.08}s`;
        });
      }

      function download() {
        const filename = `${selectedArtifact.id}-expression.md`;
        const blob = new Blob([currentExpression], { type: "text/markdown" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      // Initialize the app
      init();
    </script>
  </body>
</html>
